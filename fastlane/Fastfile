default_platform(:android)

platform :android do

  desc "Runs all the tests"
  lane :test do
    gradle(task: "test")
  end

  desc "Deploy App to test environment - Testapp.io"
  lane :deploy_testapp do
    UI.message("ğŸš€ Starting deploy_testapp lane...")
    
    # Increment version code
    UI.message("ğŸ“ˆ Incrementing version code...")
    increment_version_code
    
    # Clean and build
    UI.message("ğŸ”¨ Building APK...")
    gradle(task: "clean build", project_dir: "android/", print_command: true)
    
    # Construire le chemin du fichier APK
    apk_path = "app/build/outputs/apk/debug/app-debug.apk"
    full_apk_path = File.expand_path(apk_path)
    
    UI.message("ğŸ” Looking for APK at: #{full_apk_path}")
    
    # Debug: afficher tous les fichiers APK trouvÃ©s
    all_apks = Dir.glob("**/build/outputs/apk/**/*.apk")
    if all_apks.any?
      UI.message("âœ… Found APK files:")
      all_apks.each { |apk| UI.message("   - #{apk}") }
    else
      UI.error("âŒ No APK files found anywhere in the project!")
      UI.error("Checking build directory structure:")
      Dir.glob("**/build/outputs/**/*").each { |f| UI.message("   #{f}") }
      UI.user_error!("APK file not found!")
    end
    
    # VÃ©rifier si le fichier spÃ©cifique existe
    unless File.exist?(apk_path)
      UI.error("âŒ APK not found at expected path: #{apk_path}")
      UI.error("Using first available APK instead...")
      apk_path = all_apks.first
      UI.message("ğŸ“¦ Using APK: #{apk_path}")
    end
    
    UI.success("âœ… APK found: #{apk_path}")
    
    # Upload to TestApp.io
    UI.message("ğŸ“¤ Uploading to TestApp.io...")
    upload_to_testappio(
      api_token: ENV["TESTAPPIO_API_TOKEN"],
      app_id: ENV["TESTAPPIO_APP_ID"],
      apk_file: apk_path,
      release_notes: "Build from GitHub Actions",
      git_release_notes: true,
      git_commit_id: false,
      notify: true
    )
    
    UI.success("âœ… Deploy completed successfully!")
  end

end